# llama-node

这个项目处于早期阶段，nodejs的API可能会在未来发生变化，请谨慎使用。

<img src="./doc/assets/llama.jpeg" width="300px" height="300px" alt="LLaMA generated by bing creator"/>


![GitHub Workflow Status](https://img.shields.io/github/actions/workflow/status/hlhr202/llama-node/llama-build.yml)
![NPM](https://img.shields.io/npm/l/llama-node)
[<img alt="npm" src="https://img.shields.io/npm/v/llama-node">](https://www.npmjs.com/package/llama-node)
![npm type definitions](https://img.shields.io/npm/types/llama-node)

---

- [llama-node](#llama-node)
  - [介绍](#介绍)
  - [模型获取](#模型获取)
  - [安装](#安装)
  - [使用](#使用)
    - [推理](#推理)
    - [聊天](#聊天)
    - [分词](#分词)
    - [嵌入](#嵌入)
  - [关于性能](#关于性能)
    - [手动编译 (from node\_modules)](#手动编译-from-node_modules)
    - [手动编译 (from source)](#手动编译-from-source)
  - [未来计划](#未来计划)

---

## 介绍

这是一个基于[llama-rs](https://github.com/rustformers/llama-rs)开发的nodejs客户端库，用于Llama LLM。它使用[napi-rs](https://github.com/napi-rs/napi-rs)在node.js和llama线程之间传递消息。

当前支持平台:
- darwin-x64
- darwin-arm64
- linux-x64-gnu
- win32-x64-msvc


我没有硬件能够测试13B或更大的模型，但我已成功地测试了支持llama 7B模型的ggml llama和ggml alpaca。

<!-- Download one of the llama ggml models from the following links:
- [llama 7B int4 (old model for llama.cpp)](https://huggingface.co/hlhr202/llama-7B-ggml-int4/blob/main/ggml-model-q4_0.bin)
- [alpaca 7B int4](https://huggingface.co/hlhr202/alpaca-7B-ggml-int4/blob/main/ggml-alpaca-7b-q4.bin) -->

---

## 模型获取

由于meta发布模型仅用于研究机构测试，本项目不提供模型下载。如果你获取到了 **.pth** 原始模型，请阅读[Getting the weights](https://github.com/rustformers/llama-rs#getting-the-weights)这份文档并使用llama-rs提供的convert工具进行转化

---

## 安装
```bash
npm install llama-node
```

---

## 使用

当前版本只支持在一个LLama实例上进行单个推理会话。

如果您希望同时进行多个推理会话，则需要创建多个LLama实例。

### 推理

```typescript
import path from "path";
import { LLamaClient } from "llama-node";

const model = path.resolve(process.cwd(), "./ggml-alpaca-7b-q4.bin");

const llama = new LLamaClient(
    {
        path: model,
        numCtxTokens: 128,
    },
    true
);

const template = `how are you`;

const prompt = `Below is an instruction that describes a task. Write a response that appropriately completes the request.

### Instruction:

${template}

### Response:`;

llama.createTextCompletion(
    {
        prompt,
        numPredict: 128,
        temp: 0.2,
        topP: 1,
        topK: 40,
        repeatPenalty: 1,
        repeatLastN: 64,
        seed: 0,
        feedPrompt: true,
    },
    (response) => {
        process.stdout.write(response.token);
    }
);
```

### 聊天

这段代码目前只用于Alpaca模型，它只是建立了一个Alpaca指令的上下文。请确保您的最后一条消息以“用户角色（user role）”结尾。

```typescript
import { LLamaClient } from "llama-node";
import path from "path";

const model = path.resolve(process.cwd(), "./ggml-alpaca-7b-q4.bin");

const llama = new LLamaClient(
    {
        path: model,
        numCtxTokens: 128,
    },
    true
);

const content = "how are you?";

llama.createChatCompletion(
    {
        messages: [{ role: "user", content }],
        numPredict: 128,
        temp: 0.2,
        topP: 1,
        topK: 40,
        repeatPenalty: 1,
        repeatLastN: 64,
        seed: 0,
    },
    (response) => {
        if (!response.completed) {
            process.stdout.write(response.token);
        }
    }
);

```

### 分词

从LLama-rs中获取分词

```typescript
import { LLamaClient } from "llama-node";
import path from "path";

const model = path.resolve(process.cwd(), "./ggml-alpaca-7b-q4.bin");

const llama = new LLamaClient(
    {
        path: model,
        numCtxTokens: 128,
    },
    true
);

const content = "how are you?";

llama.tokenize(content).then(console.log);
```

### 嵌入

这是一份预览版本的代码，嵌入所使用的尾词在未来可能会发生变化。请勿在生产环境中使用！

```typescript
import { LLamaClient } from "llama-node";
import path from "path";

const model = path.resolve(process.cwd(), "./ggml-alpaca-7b-q4.bin");

const llama = new LLamaClient(
    {
        path: model,
        numCtxTokens: 128,
    },
    true
);

const prompt = `how are you`;

llama
    .getEmbedding({
        prompt,
        numPredict: 128,
        temp: 0.2,
        topP: 1,
        topK: 40,
        repeatPenalty: 1,
        repeatLastN: 64,
        seed: 0,
        feedPrompt: true,
    })
    .then(console.log);

```

---

## 关于性能

我们为linux-x64，win32-x64，apple-x64和apple-silicon提供预先构建的二进制文件。对于其他平台，在安装npm包之前，请安装用于自行构建的rust环境。

由于跨平台编译的复杂性，很难预先构建一个适合所有平台需求并具有最佳性能的二进制文件。

如果您遇到低性能问题，强烈建议您进行手动编译。否则，您需要等待我们提供更好的预编译绑定。我正在调研交叉构建的问题。


### 手动编译 (from node_modules)

- 先安装Rust环境

- 进入 node_modules/@llama-node/core

    ```shell
    npm run build
    ```

### 手动编译 (from source)

- 先安装Rust环境

- Clone之后在项目根目录运行

    ```shell
    npm install && npm run build
    ```

- 在 packages/core 目录运行
    ```shell
    npm run build
    ```

- 到此你可以使用根目录下dist目录中的js入口文件了

---

## 未来计划
- [ ] 提示词扩展
- [ ] 更多平台和处理器架构（在最高的性能条件下）
- [ ] 优化嵌入API，提供可以配置尾词的选项
- [ ] 命令行工具